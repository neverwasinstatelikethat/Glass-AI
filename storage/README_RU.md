# Хранилище данных Glass AI

## Обзор

Модуль хранения данных Glass AI обеспечивает надежное и эффективное хранение всех типов данных системы: временных рядов от датчиков, изображений с камер МИК-1, метаданных, прогнозов моделей ИИ и другой аналитической информации. Он использует специализированные базы данных для оптимального хранения и быстрого доступа к данным.

## Архитектура

```
Хранилище данных
├── Клиент InfluxDB
│   ├── Временные ряды датчиков
│   ├── Агрегированные данные
│   └── Потоковая запись
├── Клиент PostgreSQL
│   ├── Метаданные
│   ├── Конфигурации
│   └── Аналитические данные
└── Тестирование хранилища
    ├── Unit тесты
    ├── Интеграционные тесты
    └── Тесты производительности
```

## Основные компоненты

### 1. Клиент InfluxDB (`influxdb_client.py`)
Клиент для работы с базой данных временных рядов InfluxDB.

#### Особенности:
- **Хранение временных рядов**: Эффективное хранение данных датчиков
- **Потоковая запись**: Высокая пропускная способность для потоковых данных
- **Агрегации**: Встроенные функции агрегации данных
- **SQL-подобный язык запросов**: Flux для сложных аналитических запросов

#### Поддерживаемые функции:
- **Write API**: Быстрая запись точек данных
- **Query API**: Эффективное чтение и агрегация данных
- **Retention policies**: Автоматическое удаление старых данных
- **Continuous queries**: Автоматические агрегации данных

### 2. Клиент PostgreSQL (`postgres_client.py`)
Клиент для работы с реляционной базой данных PostgreSQL.

#### Особенности:
- **Хранение метаданных**: Информация о датчиках, оборудовании, моделях
- **Конфигурации**: Настройки системы и пользовательские параметры
- **Аналитические данные**: Результаты аналитики и отчеты
- **ACID транзакции**: Надежность и согласованность данных

#### Поддерживаемые функции:
- **Connection pooling**: Эффективное управление соединениями
- **Prepared statements**: Защита от SQL injection
- **JSONB поддержка**: Хранение структурированных данных
- **Partitioning**: Разделение больших таблиц для производительности

### 3. Тестирование хранилища (`test_storage.py`)
Комплексное тестирование всех компонентов хранилища данных.

#### Особенности:
- **Unit тесты**: Тестирование отдельных функций
- **Интеграционные тесты**: Тестирование взаимодействия компонентов
- **Тесты производительности**: Измерение скорости и пропускной способности
- **Тесты отказоустойчивости**: Проверка поведения при сбоях

## Структура данных

### Временные ряды (InfluxDB)
Хранение данных от датчиков в реальном времени.

#### Пример структуры:
```
measurement: sensor_data
tags:
  - production_line
  - sensor_type
  - sensor_id
fields:
  - value (float)
  - unit (string)
  - status (string)
timestamp: RFC3339
```

#### Пример записи:
```
sensor_data,production_line=Line_A,sensor_type=temperature,sensor_id=FURNACE_01 
value=1550.5,unit="C",status="OK" 1670216400000000000
```

#### Агрегированные данные:
```
measurement: aggregated_data
tags:
  - production_line
  - aggregation_type (hourly,daily,weekly)
  - parameter
fields:
  - avg_value
  - min_value
  - max_value
  - std_dev
timestamp: RFC3339
```

### Метаданные (PostgreSQL)
Хранение статической информации о системе.

#### Таблицы:
1. **sensors**: Информация о датчиках
2. **equipment**: Информация об оборудовании
3. **production_lines**: Информация о производственных линиях
4. **models**: Информация о моделях ИИ
5. **users**: Информация о пользователях
6. **configurations**: Системные конфигурации

#### Пример таблицы sensors:
```sql
CREATE TABLE sensors (
    id SERIAL PRIMARY KEY,
    sensor_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    production_line_id INTEGER REFERENCES production_lines(id),
    location TEXT,
    unit VARCHAR(20),
    min_value FLOAT,
    max_value FLOAT,
    precision INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Аналитические данные (PostgreSQL)
Хранение результатов аналитики и прогнозов.

#### Таблицы:
1. **predictions**: Прогнозы моделей ИИ
2. **recommendations**: Рекомендации системы
3. **defects**: Обнаруженные дефекты
4. **quality_metrics**: Метрики качества
5. **performance_logs**: Логи производительности

#### Пример таблицы predictions:
```sql
CREATE TABLE predictions (
    id SERIAL PRIMARY KEY,
    model_name VARCHAR(100) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    input_data JSONB,
    prediction JSONB,
    confidence FLOAT,
    actual_result JSONB,
    accuracy BOOLEAN,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Производительность

### InfluxDB
Оптимизирована для хранения временных рядов.

#### Метрики:
- **Запись**: 100,000+ точек/сек на одиночном узле
- **Чтение**: Зависит от сложности запроса и объема данных
- **Хранение**: Эффективное сжатие данных (до 60x)
- **Масштабирование**: Горизонтальное масштабирование через кластеры

#### Оптимизации:
- **Sharding**: Разделение данных по времени
- **Indexing**: Индексы по тегам для быстрого поиска
- **Compression**: Специализированное сжатие временных рядов
- **Caching**: Кэширование часто запрашиваемых данных

### PostgreSQL
Реляционная база данных для структурированных данных.

#### Метрики:
- **Транзакции**: 10,000+ TPS при правильной настройке
- **Сложные запросы**: Эффективное выполнение JOIN и агрегаций
- **Хранение**: Поддержка терабайт данных
- **Репликация**: Мастер-слейв репликация для отказоустойчивости

#### Оптимизации:
- **Индексы**: B-tree, Hash, GiST, GIN индексы
- **Partitioning**: Разделение больших таблиц
- **Connection pooling**: PgBouncer для эффективного управления соединениями
- **Query optimization**: Автоматическая оптимизация планов запросов

## Конфигурация

### Параметры подключения:
```json
{
  "influxdb": {
    "url": "http://localhost:8086",
    "token": "my-token",
    "org": "glass-ai",
    "bucket": "sensor-data"
  },
  "postgresql": {
    "host": "localhost",
    "port": 5432,
    "database": "glassai",
    "username": "glassai",
    "password": "password",
    "pool_size": 20
  }
}
```

### Политики хранения:
```json
{
  "retention_policies": {
    "raw_data": "30d",
    "hourly_aggregates": "180d",
    "daily_aggregates": "365d"
  }
}
```

## Безопасность

### Аутентификация:
- **Токены**: InfluxDB токены для API доступа
- **Пользователи/пароли**: PostgreSQL аутентификация
- **SSL/TLS**: Шифрование данных в передаче
- **OAuth2**: Интеграция с корпоративными системами

### Авторизация:
- **Роли**: Разграничение прав доступа
- **Permissions**: Гранулярный контроль доступа к данным
- **Row-level security**: Ограничение доступа на уровне строк

### Шифрование:
- **Данные в передаче**: SSL/TLS для всех соединений
- **Данные в покое**: Шифрование файлов баз данных
- **Резервные копии**: Шифрование резервных копий

## Резервное копирование и восстановление

### InfluxDB:
- **Snapshot backups**: Полные снимки базы данных
- **Incremental backups**: Инкрементальные резервные копии
- **Continuous backup**: Непрерывное резервное копирование
- **Point-in-time recovery**: Восстановление на определенный момент времени

### PostgreSQL:
- **pg_dump**: Логические резервные копии
- **Physical backups**: Физические резервные копии файлов
- **WAL archiving**: Архивирование журналов транзакций
- **Point-in-time recovery**: Восстановление на определенный момент времени

## Мониторинг

### Метрики производительности:
- **InfluxDB**: 
  - Write throughput
  - Query response times
  - Disk usage
  - Memory usage
- **PostgreSQL**:
  - Connection count
  - Transaction rate
  - Query performance
  - Disk I/O

### Алерты:
- **Дисковое пространство**: Предупреждения о заполнении диска
- **Производительность**: Оповещения о снижении производительности
- **Отказы**: Уведомления о сбоях в работе баз данных
- **Безопасность**: Оповещения о подозрительной активности

## Интеграция с другими модулями

### С системой сбора данных:
- **Потоковая запись**: Непрерывная запись данных датчиков
- **Буферизация**: Временное хранение при недоступности баз данных
- **Подтверждение записи**: Гарантированная доставка данных

### С моделями ИИ:
- **Хранение прогнозов**: Сохранение результатов прогнозов
- **Исторические данные**: Предоставление исторических данных для обучения
- **Метрики качества**: Хранение метрик точности моделей

### С фронтендом:
- **Аналитические данные**: Предоставление агрегированных данных для дашбордов
- **Метаданные**: Информация о датчиках и оборудовании
- **Отчеты**: Генерация аналитических отчетов

## Тестирование

### Unit тесты:
```bash
pytest tests/storage/
```

### Интеграционные тесты:
- **Тестирование подключения**: Проверка соединения с базами данных
- **Тестирование CRUD операций**: Создание, чтение, обновление, удаление данных
- **Тестирование агрегаций**: Проверка корректности агрегированных данных

### Тесты производительности:
- **Нагрузочное тестирование**: Проверка при высокой нагрузке
- **Стресс-тестирование**: Проверка при экстремальных условиях
- **Тесты масштабирования**: Проверка горизонтального масштабирования

## Развертывание

### Docker:
```dockerfile
FROM postgres:14

ENV POSTGRES_DB=glassai
ENV POSTGRES_USER=glassai
ENV POSTGRES_PASSWORD=password

COPY init-scripts/ /docker-entrypoint-initdb.d/
```

### Docker Compose:
```yaml
version: '3.8'
services:
  influxdb:
    image: influxdb:2.0
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password
  
  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_DB=glassai
      - POSTGRES_USER=glassai
      - POSTGRES_PASSWORD=password

volumes:
  influxdb_data:
  postgres_data:
```

## Устранение неполадок

### Распространенные проблемы:

1. **Медленные запросы**:
   - Проверьте индексы
   - Оптимизируйте запросы
   - Увеличьте ресурсы сервера

2. **Проблемы с подключением**:
   - Проверьте сетевые настройки
   - Убедитесь в доступности сервисов
   - Проверьте учетные данные

3. **Недостаток дискового пространства**:
   - Настройте политики хранения
   - Очистите старые данные
   - Расширьте дисковое пространство

## Версионирование

### Совместимость версий:
- **InfluxDB 2.x**: Современная версия с улучшенной производительностью
- **PostgreSQL 13+**: Поддержка современных функций
- **API совместимость**: Стабильные API для клиентов

### Миграции:
- **Schema migrations**: Скрипты обновления структуры баз данных
- **Data migrations**: Скрипты переноса данных между версиями
- **Rollback procedures**: Процедуры отката изменений

## Логирование

### Уровни логирования:
- **DEBUG**: Подробная информация для диагностики
- **INFO**: Общая информация о работе системы
- **WARNING**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, требующие внимания
- **CRITICAL**: Критические ошибки, требующие немедленного вмешательства

### Структура логов:
- **Временные метки**: Точное время событий
- **Уровень логирования**: Категория сообщения
- **Компонент**: Источник сообщения
- **Сообщение**: Текстовое описание события
- **Контекст**: Дополнительная информация о состоянии