# Граф знаний Glass AI

## Обзор

Модуль графа знаний системы Glass AI реализует причинно-следственный анализ производственных данных и обнаружение корневых причин дефектов. Он использует графовые структуры для представления взаимосвязей между параметрами производства, дефектами и рекомендациями.

## Архитектура

```
Граф знаний
├── Причинно-следственный граф
│   ├── Узлы (Nodes)
│   ├── Ребра (Edges)
│   ├── Свойства узлов
│   └── Свойства ребер
├── Инициализатор базы знаний
│   ├── Загрузка синтетических данных
│   ├── Создание начальных узлов
│   └── Установка причинно-следственных связей
└── Анализатор корневых причин
    ├── Алгоритмы обхода графа
    ├── Поиск путей
    └── Ранжирование причин
```

## Основные компоненты

### 1. Причинно-следственный граф (`causal_graph.py`)
Реализация графа знаний для анализа причинно-следственных связей в производственном процессе.

#### Особенности:
- **Узлы**: Представление параметров производства, дефектов, оборудования
- **Ребра**: Причинно-следственные связи между узлами
- **Свойства узлов**: Метаданные об узлах (тип, значение, единица измерения)
- **Свойства ребер**: Типы связей (влияет на, вызывает, коррелирует)

### 2. Инициализатор базы знаний (`knowledge_base_initializer.py`)
Инициализация графа знаний с предопределенными связями и синтетическими данными.

#### Особенности:
- **Загрузка синтетических данных**: Создание тестовых сценариев
- **Создание начальных узлов**: Инициализация узлов оборудования и параметров
- **Установка связей**: Определение причинно-следственных связей

### 3. Анализатор корневых причин (`root_cause_analyzer.py`)
Анализ корневых причин дефектов с использованием алгоритмов обхода графа.

#### Особенности:
- **Алгоритмы обхода**: DFS, BFS для поиска путей в графе
- **Поиск путей**: Определение цепочек причинно-следственных связей
- **Ранжирование причин**: Оценка значимости причин по силе связей

## Структура графа

### Типы узлов:
1. **Equipment (Оборудование)**: Печь, формовочная линия, конвейер
2. **Parameter (Параметр)**: Температура, давление, скорость
3. **Defect (Дефект)**: Трещины, пузыри, сколы
4. **Action (Действие)**: Рекомендации по корректировке
5. **Cause (Причина)**: Корневые причины дефектов

### Типы ребер:
1. **CAUSES (Вызывает)**: Прямая причинно-следственная связь
2. **INFLUENCES (Влияет на)**: Косвенное влияние
3. **CORRELATES_WITH (Коррелирует с)**: Статистическая корреляция
4. **RECOMMENDS (Рекомендует)**: Рекомендация по устранению

## Причинно-следственные связи

### Основные связи:
```
Температура_печи --ВЛИЯЕТ_НА--> Вязкость_стекла --ВЫЗЫВАЕТ--> Трещины
Скорость_ленты --ВЛИЯЕТ_НА--> Толщина_стенки --ВЫЗЫВАЕТ--> Деформация
Давление_формования --ВЛИЯЕТ_НА--> Качество_поверхности --ВЫЗЫВАЕТ--> Пузыри
```

### Сложные сценарии:
```
[Температура_печи] --ВЛИЯЕТ_НА--> [Вязкость_стекла]
[Вязкость_стекла] --ВЛИЯЕТ_НА--> [Формование_качество]
[Скорость_ленты] --ВЛИЯЕТ_НА--> [Формование_качество]
[Формование_качество] --ВЫЗЫВАЕТ--> [Трещины]
[Температура_формы] --ВЛИЯЕТ_НА--> [Напряжения_внутренние]
[Напряжения_внутренние] --ВЫЗЫВАЕТ--> [Трещины]
```

## Инициализация графа

### Начальные узлы:
- **Печь**: Температура, давление, уровень расплава
- **Формование**: Скорость ленты, температура формы, давление
- **Отжиг**: Температура изделия, скорость охлаждения
- **Качество**: Типы дефектов, количество дефектов

### Предопределенные связи:
- Температура печи → Влияет на → Вязкость стекла
- Вязкость стекла → Вызывает → Трещины
- Скорость формования → Влияет на → Толщина стенки
- Толщина стенки → Вызывает → Деформация
- Температура формы → Влияет на → Внутренние напряжения
- Внутренние напряжения → Вызывает → Трещины

## Анализ корневых причин

### Алгоритм анализа:
1. **Идентификация дефекта**: Определение типа и локализации дефекта
2. **Поиск обратных путей**: Поиск всех путей от дефекта к параметрам
3. **Оценка путей**: Расчет силы связей по каждому пути
4. **Ранжирование причин**: Сортировка причин по значимости
5. **Формирование отчета**: Генерация объяснения для оператора

### Метрики оценки:
- **Сила связи**: Вес ребра, представляющий силу связи
- **Длина пути**: Количество переходов от причины к следствию
- **Комбинированная оценка**: Комбинация силы и длины пути

## Интеграция с другими модулями

### С моделями ИИ:
- Получение прогнозов дефектов от LSTM, ViT, GNN
- Использование прогнозов для активации анализа причин
- Интеграция неопределенности прогнозов

### С RL агентом:
- Предоставление контекста для рекомендаций
- Объяснение причин дефектов для RL агента
- Уточнение причинно-следственных связей на основе действий

### С цифровым двойником:
- Верификация причинно-следственных связей в симуляциях
- Обновление графа на основе результатов симуляций
- Что-если анализ для проверки гипотез

## API графа знаний

### Получение причин для дефекта:
```
GET /api/knowledge-graph/root-causes/{defect_type}
```

### Добавление новой связи:
```
POST /api/knowledge-graph/relationships
{
  "source": "Температура_печи",
  "target": "Вязкость_стекла",
  "relationship": "INFLUENCES",
  "strength": 0.85
}
```

### Обновление узла:
```
PUT /api/knowledge-graph/nodes/{node_id}
{
  "properties": {
    "value": 1550.0,
    "unit": "°C",
    "timestamp": "2025-12-05T10:00:00Z"
  }
}
```

## Визуализация графа

### D3.js компонент:
- Интерактивная визуализация графа знаний
- Цветовое кодирование узлов по типам
- Анимация путей причинно-следственных связей
- Инструменты масштабирования и навигации

### Функции визуализации:
- **Раскладка графа**: Force-directed layout для оптимального расположения
- **Интерактивность**: Клик по узлам для получения деталей
- **Фильтрация**: Фильтр по типам узлов и ребер
- **Поиск**: Поиск узлов по названию

## Обновление графа

### Динамическое обновление:
- Добавление новых узлов на основе данных датчиков
- Обновление свойств узлов в реальном времени
- Создание новых связей на основе корреляций
- Удаление устаревших связей

### Механизмы обучения:
- **Обратное распространение**: Обновление связей на основе результатов действий
- **Подтверждение гипотез**: Верификация причинно-следственных связей
- **Отклонение гипотез**: Удаление ложных связей

## Производительность

### Метрики производительности:
- **Время поиска путей**: < 50 мс для графов до 1000 узлов
- **Память**: < 100 МБ для среднего графа
- **Масштабируемость**: Поддержка до 10000 узлов

### Оптимизации:
- **Кэширование путей**: Кэширование часто запрашиваемых путей
- **Индексация**: Индексы для быстрого поиска узлов
- **Параллельные вычисления**: Многопоточность для сложных запросов

## Безопасность

### Целостность данных:
- **Валидация входных данных**: Проверка корректности новых узлов и связей
- **Ограничения типов**: Строгая типизация узлов и ребер
- **Аудит изменений**: Логирование всех изменений графа

### Контроль доступа:
- **JWT аутентификация**: Защита API эндпоинтов
- **Роли пользователей**: Разграничение прав на чтение/запись
- **Шифрование**: TLS для всех сетевых взаимодействий

## Тестирование

### Юнит-тесты:
```bash
pytest tests/knowledge_graph/
```

### Тесты интеграции:
- Тестирование взаимодействия с моделями ИИ
- Тестирование API эндпоинтов
- Тестирование алгоритмов анализа причин

### Тесты производительности:
- Измерение времени поиска путей
- Тестирование масштабирования графа
- Стресс-тестирование с большими графами

## Развертывание

### Локальное развертывание:
```bash
python -m knowledge_graph.causal_graph
```

### Docker развертывание:
```dockerfile
FROM python:3.8-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY knowledge_graph/ knowledge_graph/

CMD ["python", "-m", "knowledge_graph.causal_graph"]
```

## Мониторинг

### Метрики:
- **Количество узлов**: Общее количество узлов в графе
- **Количество ребер**: Общее количество связей
- **Время запросов**: Латентность API эндпоинтов
- **Частота обновлений**: Количество обновлений в минуту

### Логирование:
- **Изменения графа**: Все модификации структуры графа
- **Запросы API**: Все обращения к эндпоинтам
- **Ошибки**: Исключения и ошибки выполнения

## Устранение неполадок

### Распространенные проблемы:

1. **Медленный поиск путей**:
   - Проверьте индексацию узлов
   - Оптимизируйте алгоритмы обхода
   - Рассмотрите кэширование частых запросов

2. **Некорректные связи**:
   - Проверьте валидацию входных данных
   - Убедитесь в корректности алгоритмов обновления
   - Проверьте обратное распространение

3. **Проблемы с визуализацией**:
   - Проверьте совместимость браузера
   - Убедитесь в наличии WebGL поддержки
   - Проверьте размер графа для отображения

## Расширяемость

### Добавление новых типов узлов:
- Определение новых классов узлов
- Реализация специфичных свойств
- Обновление валидации

### Добавление алгоритмов анализа:
- Реализация новых алгоритмов обхода
- Добавление метрик оценки
- Интеграция с API

## Версионирование

### Управление версиями графа:
- **Снимки графа**: Периодические снимки структуры графа
- **Миграции**: Скрипты для обновления структуры
- **Откат изменений**: Возможность восстановления предыдущих версий

## Логирование и аудит

### Аудит изменений:
- **Кто**: Идентификатор пользователя или системы
- **Что**: Описание изменения
- **Когда**: Временная метка изменения
- **Почему**: Причина изменения (если указана)