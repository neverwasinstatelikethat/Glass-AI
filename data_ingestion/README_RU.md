# Система сбора данных Glass AI

## Обзор

Система сбора данных Glass AI отвечает за сбор, маршрутизацию и обработку данных из различных промышленных источников на стекольных предприятиях. Она предоставляет унифицированный интерфейс для подключения к серверам OPC UA, устройствам Modbus, системам камер МИК-1 и брокерам MQTT.

## Архитектура

```
Система сбора данных
├── Сборщик данных
│   ├── Клиент OPC UA
│   ├── Драйвер Modbus
│   ├── Поток данных с камеры МИК-1
│   └── Коннектор MQTT
├── Маршрутизатор данных
│   ├── Продюсер Kafka
│   ├── Извлечение признаков
│   ├── Валидатор данных
│   └── Буфер данных
└── Конфигурация и настройка
    ├── Системная конфигурация
    ├── Настройка окружения
    └── Управление зависимостями
```

## Основные компоненты

### 1. Сборщик данных
- **Клиент OPC UA**: Подключение к системам промышленной автоматизации
- **Драйвер Modbus**: Коммуникация с ПЛК и промышленными устройствами
- **Поток данных с камеры МИК-1**: Обработка данных визуального контроля
- **Коннектор MQTT**: Обработка коммуникаций с IoT устройствами

### 2. Маршрутизатор данных
- **Продюсер Kafka**: Потоковая передача данных в темы Kafka
- **Извлечение признаков**: Вычисление признаков в реальном времени из данных датчиков
- **Валидатор данных**: Валидация и обнаружение аномалий во входящих данных
- **Буфер данных**: Временное хранение данных во время проблем системы

### 3. Конфигурация и настройка
- **Системная конфигурация**: Управление общесистемными настройками
- **Настройка окружения**: Обработка конфигураций для конкретных окружений
- **Управление зависимостями**: Обеспечение наличия всех необходимых пакетов

## Особенности

- **Поддержка множества протоколов**: OPC UA, Modbus TCP/RTU, MQTT, потоки данных с камер
- **Обработка в реальном времени**: Сбор и маршрутизация данных с низкой задержкой
- **Отказоустойчивость**: Автоматическое переподключение и буферизация данных
- **Масштабируемая архитектура**: Поддержка горизонтального масштабирования
- **Мониторинг и метрики**: Встроенные проверки состояния и метрики производительности
- **Безопасность**: Поддержка TLS/SSL и аутентификация

## Установка

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск настройки
python setup.py
```

## Конфигурация

Система может быть сконфигурирована через:
1. **Файл конфигурации**: `data_ingestion_config.json`
2. **Переменные окружения**: файл `.env`
3. **Аргументы командной строки**: параметры времени выполнения

## Использование

### Базовое использование
```python
from data_ingestion.main import DataIngestionSystem

# Создание и запуск системы
system = DataIngestionSystem()
await system.initialize_system()
await system.start_system()
```

### Пользовательская конфигурация
```python
from data_ingestion.setup import DataIngestionSetup

# Загрузка пользовательской конфигурации
setup = DataIngestionSetup("custom_config.json")
config = setup.load_config()
```

## Поток данных

1. **Сбор**: Данные собираются со всех сконфигурированных источников
2. **Валидация**: Входящие данные валидируются и проверяются на аномалии
3. **Маршрутизация**: Валидные данные направляются в соответствующие места назначения
4. **Обработка**: Из данных датчиков извлекаются признаки в реальном времени
5. **Хранение**: Данные потоково передаются в Kafka для дальнейшей обработки

## Мониторинг

Система предоставляет:
- **Проверки состояния**: Периодическая верификация состояния системы
- **Метрики производительности**: Скорость сбора, количество ошибок, пропускная способность
- **Логирование**: Комплексное логирование с настраиваемыми уровнями
- **Алерты**: Уведомления о критических проблемах

## Безопасность

- **Аутентификация**: Аутентификация по имени пользователя/паролю и сертификатам
- **Шифрование**: Поддержка TLS/SSL для всех соединений
- **Контроль доступа**: Контроль доступа на основе ролей к компонентам системы

## Промышленные коннекторы

### OPC UA клиент
- Подключение к промышленным серверам OPC UA
- Чтение тегов в реальном времени
- Поддержка различных типов данных
- Обработка разрывов соединения

### Драйвер Modbus
- Коммуникация по протоколу Modbus TCP/RTU
- Чтение и запись регистров
- Поддержка различных типов устройств
- Обработка ошибок связи

### Поток данных с камеры МИК-1
- Обработка видеопотока с камеры МИК-1
- Извлечение изображений дефектов
- Передача данных в систему компьютерного зрения
- Интеграция с системой визуального контроля

### Агрегатор датчиков
- Агрегация данных от множества датчиков
- Преобразование данных в унифицированный формат
- Фильтрация и предварительная обработка
- Буферизация данных при недоступности систем

## Потоковая передача данных

### Продюсер Kafka
- Публикация данных в темы Kafka
- Гарантированная доставка сообщений
- Поддержка партиционирования
- Мониторинг производительности

### Валидатор данных
- Проверка целостности данных
- Обнаружение аномалий и выбросов
- Фильтрация некорректных данных
- Логирование ошибок валидации

## Инжиниринг признаков

### Признаки доменной области
- Физические признаки производства стекла
- Параметры плавления и формования
- Энергоэффективность процессов
- Индикаторы потенциальных дефектов

### Статистические признаки
- Скользящие средние, стандартные отклонения
- Скорости изменения параметров
- Обнаружение трендов
- Автокорреляция

### Признаки реального времени
- Оконные функции временных рядов
- Интеграция с InfluxDB
- Агрегации в реальном времени
- Обновление признаков каждые 5 секунд

## Разработка

### Запуск тестов
```bash
pytest tests/
```

### Форматирование кода
```bash
black .
flake8 .
```

### Проверка типов
```bash
mypy .
```

## Производительность

### Целевые показатели:
- **Скорость сбора**: 1000+ сообщений/сек
- **Задержка обработки**: < 50 мс
- **Доступность**: 99.9%
- **Время восстановления**: < 30 сек

### Мониторинг:
- **Счетчики сообщений**: Количество обработанных сообщений
- **Время обработки**: Латентность обработки сообщений
- **Ошибки**: Количество ошибок валидации и обработки
- **Пропускная способность**: Сообщений в секунду

## Интеграция

### С бэкендом:
- Передача данных через Kafka
- API для управления конфигурацией
- Мониторинг состояния системы

### С моделями ИИ:
- Предоставление признаков для прогнозирования
- Потоковая передача данных для обучения
- Обратная связь от моделей

### С хранилищем данных:
- Сохранение исторических данных
- Интеграция с InfluxDB и PostgreSQL
- Архивация данных

## Устранение неполадок

### Распространенные проблемы:

1. **Потеря соединения с OPC UA сервером**:
   - Проверьте сетевое соединение
   - Убедитесь, что сервер доступен
   - Проверьте учетные данные

2. **Ошибки валидации данных**:
   - Проверьте формат данных
   - Убедитесь, что все обязательные поля присутствуют
   - Проверьте диапазоны значений

3. **Проблемы с Kafka**:
   - Проверьте доступность брокера
   - Убедитесь, что темы существуют
   - Проверьте права доступа

## Масштабирование

### Горизонтальное масштабирование:
- Запуск нескольких экземпляров сборщиков данных
- Партиционирование данных по источникам
- Балансировка нагрузки

### Вертикальное масштабирование:
- Увеличение ресурсов одного экземпляра
- Оптимизация обработки данных
- Использование более мощных серверов

## Логирование и диагностика

### Уровни логирования:
- **DEBUG**: Подробная информация для диагностики
- **INFO**: Общая информация о работе системы
- **WARNING**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, требующие внимания
- **CRITICAL**: Критические ошибки, требующие немедленного вмешательства

### Метрики:
- **Счетчики**: Количество обработанных сообщений, ошибок
- **Гистограммы**: Время обработки, размеры сообщений
- **Счетчики состояния**: Состояние подключений, буферов

## Лицензирование

Система распространяется под лицензией MIT. Подробности см. в файле LICENSE.