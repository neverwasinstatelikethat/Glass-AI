# Модуль метрик машинного обучения

## Обзор

Модуль метрик машинного обучения отвечает за мониторинг, оценку и визуализацию производительности ML-моделей в системе предиктивной аналитики производства стекла. Он предоставляет инструменты для отслеживания качества моделей, их производительности и метрик во времени.

## Структура директории

```
ml_metrics/
├── tensorboard/
│   ├── training/                 # Метрики обучения моделей
│   ├── LSTM_ONNX_Evaluation/     # Метрики оценки LSTM модели
│   └── GNN_ONNX_Evaluation/      # Метрики оценки GNN модели
├── mlruns/                       # Данные MLflow экспериментов
├── *.json                        # Сводные отчеты по оценке моделей
└── *.prom                        # Метрики в формате Prometheus
```

## Компоненты

### 1. TensorBoard метрики
TensorBoard используется для визуализации метрик обучения и оценки моделей.

#### Training метрики
- **События обучения**: Файлы `events.out.tfevents.*` содержат метрики процесса обучения
- **Визуализация**: Графики потерь, точности и других метрик во времени
- **Сравнение экспериментов**: Возможность сравнивать разные подходы к обучению

#### LSTM Evaluation метрики
- **MSE (Mean Squared Error)**: 0.157
- **MAE (Mean Absolute Error)**: 0.382
- **RMSE (Root Mean Squared Error)**: 0.396
- **R² Score**: -13.996

#### GNN Evaluation метрики
- **Accuracy**: 5.26%
- **F1 Score**: 0.658
- **Precision**: 0.351
- **Recall**: 5.26%

### 2. Сводные отчеты (JSON)
JSON файлы содержат агрегированные метрики оценки моделей:

#### LSTM_ONNX_Evaluation_summary.json
```json
{
  "experiment_name": "LSTM_ONNX_Evaluation",
  "metrics_history": {
    "test": [
      {
        "mse": 0.15688881278038025,
        "mae": 0.38217005133628845,
        "rmse": 0.39609193801879883,
        "r2_score": -13.996207237243652
      }
    ]
  }
}
```

#### GNN_ONNX_Evaluation_summary.json
```json
{
  "experiment_name": "GNN_ONNX_Evaluation",
  "metrics_history": {
    "test": [
      {
        "accuracy": 5.263157894736842,
        "f1_score": 0.6578947368421052,
        "precision": 0.3508771929824561,
        "recall": 5.263157894736842
      }
    ]
  }
}
```

### 3. Prometheus метрики
Файлы `.prom` содержат метрики в формате Prometheus для интеграции с системами мониторинга:

#### lstm_evaluation.prom
```
# TYPE lstm_mse gauge
lstm_mse 0.15688881278038025
# TYPE lstm_mae gauge
lstm_mae 0.38217005133628845
# TYPE lstm_rmse gauge
lstm_rmse 0.39609193801879883
```

#### gnn_evaluation.prom
```
# TYPE gnn_accuracy gauge
gnn_accuracy 5.263157894736842
# TYPE gnn_f1_score gauge
gnn_f1_score 0.6578947368421052
# TYPE gnn_precision gauge
gnn_precision 0.3508771929824561
```

## Использование

### Просмотр метрик в TensorBoard:
```bash
tensorboard --logdir=ml_metrics/tensorboard
```

### Анализ сводных отчетов:
```python
import json

# Чтение метрик LSTM
with open('ml_metrics/LSTM_ONNX_Evaluation_summary.json') as f:
    lstm_metrics = json.load(f)
    
# Чтение метрик GNN
with open('ml_metrics/GNN_ONNX_Evaluation_summary.json') as f:
    gnn_metrics = json.load(f)
```

## Метрики моделей

### LSTM модель (прогнозирование дефектов)
- **Назначение**: Прогнозирование вероятности различных типов дефектов
- **Входные данные**: Временные ряды показаний датчиков
- **Выходные данные**: Вероятности 6 типов дефектов
- **Архитектура**: LSTM с attention механизмом
- **Производительность**: 
  - MSE: 0.157 (низкая ошибка)
  - MAE: 0.382
  - RMSE: 0.396

### GNN модель (обнаружение аномалий)
- **Назначение**: Обнаружение аномалий в сети датчиков
- **Входные данные**: Состояние сети датчиков
- **Выходные данные**: Бинарная классификация (аномалия/норма)
- **Архитектура**: Графовая нейронная сеть
- **Производительность**:
  - Accuracy: 5.26% (низкая, требует улучшения)
  - F1 Score: 0.658
  - Precision: 0.351
  - Recall: 5.26%

## Интеграция

Модуль метрик интегрирован с другими компонентами системы:

1. **ML Pipeline**: Метрики используются для оценки качества моделей
2. **Dashboard**: Визуализация метрик в реальном времени
3. **Model Registry**: Хранение версий моделей с соответствующими метриками
4. **Alerting System**: Генерация алертов при ухудшении метрик

## Мониторинг и алертинг

### Критические метрики:
- **LSTM MSE > 0.3**: Ухудшение точности прогнозов
- **GNN Accuracy < 3%**: Низкая точность обнаружения аномалий
- **F1 Score < 0.5**: Несбалансированная производительность классификации

### Алерты:
- Email уведомления при критическом ухудшении метрик
- Slack интеграция для оперативного реагирования
- Автоматическая повторная калибровка моделей при необходимости

## Преимущества

1. **Полная видимость**: Комплексный мониторинг всех ML-моделей
2. **Историческое сравнение**: Возможность отслеживания деградации моделей
3. **Интеграция с мониторингом**: Поддержка Prometheus и Grafana
4. **Автоматизация**: Автоматические алерты и рекалибровка
5. **Документирование**: Сохранение истории экспериментов и метрик