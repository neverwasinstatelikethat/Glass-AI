{"ast":null,"code":"import _objectSpread from\"C:/Users/hehehe/Desktop/scripts/glass_ai/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{Canvas}from'@react-three/fiber';import{OrbitControls,PerspectiveCamera,Environment,Html}from'@react-three/drei';import*as THREE from'three';import{Typography,Fab,IconButton,Slider,FormControl,InputLabel,Select,MenuItem,Checkbox,FormControlLabel,FormGroup,Paper}from'@mui/material';import useWebSocket from'../hooks/useWebSocket';import{systemApi}from'../services/api';import{PlayArrow,Pause,RotateLeft,ZoomIn,ZoomOut,Visibility,VisibilityOff,Settings,Warning}from'@mui/icons-material';// Цветовая палитра РТУ МИРЭА\nimport{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const MIREA_COLORS={primary:'#0066CC',secondary:'#FF6B35',success:'#00C853',warning:'#FFA726',error:'#EF5350',info:'#29B6F6',background:'#0A1929',surfaceLight:'#2A3A4F',text:'#FFFFFF'};// Types\n// Печь для стекла\nconst GlassFurnace=_ref=>{let{temperature,meltLevel,defects,showDefects}=_ref;const getColor=temp=>{const normalized=Math.min(1,Math.max(0,(temp-1400)/200));return new THREE.Color(Math.min(1,normalized*2),Math.max(0,1-Math.abs(normalized-0.5)*2),Math.max(0,(1-normalized)*2));};return/*#__PURE__*/_jsxs(\"group\",{position:[0,0,0],children:[/*#__PURE__*/_jsxs(\"mesh\",{position:[0,2,0],children:[/*#__PURE__*/_jsx(\"boxGeometry\",{args:[4,4,4]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:getColor(temperature),transparent:true,opacity:0.8,emissive:getColor(temperature),emissiveIntensity:0.2})]}),/*#__PURE__*/_jsxs(\"mesh\",{position:[0,0.5,0],children:[/*#__PURE__*/_jsx(\"cylinderGeometry\",{args:[1.5,1.8,meltLevel*0.5,32]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:\"#ff9800\",transparent:true,opacity:0.7})]}),showDefects&&defects.map((defect,index)=>/*#__PURE__*/_jsxs(\"mesh\",{position:defect.position,children:[/*#__PURE__*/_jsx(\"sphereGeometry\",{args:[defect.severity*0.1,16,16]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:defect.type==='bubble'?'#00bcd4':defect.type==='crack'?'#f44336':'#ffeb3b',emissive:defect.type==='bubble'?'#00bcd4':defect.type==='crack'?'#f44336':'#ffeb3b',emissiveIntensity:0.3}),/*#__PURE__*/_jsx(Html,{distanceFactor:10,children:/*#__PURE__*/_jsx(\"div\",{style:{background:'rgba(0,0,0,0.7)',padding:'4px 8px',borderRadius:'4px',color:'white',fontSize:'10px'},children:defect.type==='bubble'?'Пузырь':defect.type==='crack'?'Трещина':'Скол'})})]},index))]});};// Формовочная линия\nconst FormingLine=_ref2=>{let{beltSpeed,moldTemp,showLabels}=_ref2;return/*#__PURE__*/_jsxs(\"group\",{position:[6,0,0],children:[/*#__PURE__*/_jsxs(\"mesh\",{position:[0,0.5,0],rotation:[Math.PI/2,0,0],children:[/*#__PURE__*/_jsx(\"boxGeometry\",{args:[8,0.1,2]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:\"#795548\"})]}),/*#__PURE__*/_jsxs(\"mesh\",{position:[0,1.5,0],children:[/*#__PURE__*/_jsx(\"boxGeometry\",{args:[2,2,2]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:\"#607d8b\",emissive:\"#607d8b\",emissiveIntensity:moldTemp>320?0.2:0})]}),showLabels&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Html,{position:[0,3,0],center:true,children:/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(0,0,0,0.7)',padding:'4px 8px',borderRadius:'4px',color:'white'},children:[\"\\u0421\\u043A\\u043E\\u0440\\u043E\\u0441\\u0442\\u044C \\u043B\\u0435\\u043D\\u0442\\u044B: \",beltSpeed,\" \\u043C/\\u043C\\u0438\\u043D\"]})}),/*#__PURE__*/_jsx(Html,{position:[0,2.5,0],center:true,children:/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(0,0,0,0.7)',padding:'4px 8px',borderRadius:'4px',color:'white'},children:[\"\\u0422\\u0435\\u043C\\u043F\\u0435\\u0440\\u0430\\u0442\\u0443\\u0440\\u0430 \\u0444\\u043E\\u0440\\u043C\\u044B: \",moldTemp,\"\\xB0C\"]})})]})]});};// Конвейерная система\nconst ConveyorSystem=_ref3=>{let{speed,showLabels}=_ref3;return/*#__PURE__*/_jsxs(\"group\",{position:[-6,0,0],children:[/*#__PURE__*/_jsxs(\"mesh\",{position:[0,0.5,0],rotation:[Math.PI/2,0,0],children:[/*#__PURE__*/_jsx(\"boxGeometry\",{args:[8,0.1,2]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:\"#9e9e9e\"})]}),[...Array(5)].map((_,i)=>/*#__PURE__*/_jsxs(\"mesh\",{position:[-3+i*1.5,1,0],children:[/*#__PURE__*/_jsx(\"cylinderGeometry\",{args:[0.3,0.3,2,32]}),/*#__PURE__*/_jsx(\"meshStandardMaterial\",{color:\"#616161\"})]},i)),showLabels&&/*#__PURE__*/_jsx(Html,{position:[0,2,0],center:true,children:/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(0,0,0,0.7)',padding:'4px 8px',borderRadius:'4px',color:'white'},children:[\"\\u0421\\u043A\\u043E\\u0440\\u043E\\u0441\\u0442\\u044C \\u043A\\u043E\\u043D\\u0432\\u0435\\u0439\\u0435\\u0440\\u0430: \",speed,\" \\u043C/\\u043C\\u0438\\u043D\"]})})]});};// Главная 3D сцена\nconst GlassProductionScene=_ref4=>{let{sensorData,showDefects,showLabels}=_ref4;const generateDefects=()=>{const defects=[];Object.entries(sensorData.defects).forEach(_ref5=>{let[type,count]=_ref5;for(let i=0;i<count;i++){defects.push({position:[(Math.random()-0.5)*3,2+Math.random()*2,(Math.random()-0.5)*3],type,severity:Math.random()});}});return defects;};const defects=generateDefects();return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"ambientLight\",{intensity:0.5}),/*#__PURE__*/_jsx(\"pointLight\",{position:[10,10,10],intensity:1}),/*#__PURE__*/_jsx(\"spotLight\",{position:[0,10,0],angle:0.3,penumbra:1,intensity:1,castShadow:true}),/*#__PURE__*/_jsx(GlassFurnace,{temperature:sensorData.furnace.temperature,meltLevel:sensorData.furnace.meltLevel,defects:defects,showDefects:showDefects}),/*#__PURE__*/_jsx(FormingLine,{beltSpeed:sensorData.forming.beltSpeed,moldTemp:sensorData.forming.moldTemp,showLabels:showLabels}),/*#__PURE__*/_jsx(ConveyorSystem,{speed:sensorData.forming.beltSpeed*0.8,showLabels:showLabels}),/*#__PURE__*/_jsx(OrbitControls,{enablePan:true,enableZoom:true,enableRotate:true}),/*#__PURE__*/_jsx(PerspectiveCamera,{makeDefault:true,position:[0,5,15],fov:50}),/*#__PURE__*/_jsx(Environment,{preset:\"city\"})]});};// AR наложение\nconst AROverlay=_ref6=>{var _sensorData$furnace,_sensorData$furnace$t,_sensorData$forming,_sensorData$forming$b;let{sensorData,defects,showOverlay}=_ref6;if(!showOverlay)return null;return/*#__PURE__*/_jsxs(\"div\",{style:{position:'absolute',top:0,left:0,width:'100%',height:'100%',pointerEvents:'none',zIndex:1000},children:[/*#__PURE__*/_jsxs(Paper,{elevation:4,style:{position:'absolute',top:'20%',left:'10%',background:'rgba(0, 0, 0, 0.8)',padding:'16px',borderRadius:'8px',border:\"2px solid \".concat(MIREA_COLORS.secondary)},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",style:{color:MIREA_COLORS.text},children:\"\\u041F\\u0435\\u0447\\u044C\"}),/*#__PURE__*/_jsxs(Typography,{variant:\"h6\",style:{color:MIREA_COLORS.secondary,fontWeight:700},children:[((_sensorData$furnace=sensorData.furnace)===null||_sensorData$furnace===void 0?void 0:(_sensorData$furnace$t=_sensorData$furnace.temperature)===null||_sensorData$furnace$t===void 0?void 0:_sensorData$furnace$t.toFixed(0))||0,\"\\xB0C\"]})]}),/*#__PURE__*/_jsxs(Paper,{elevation:4,style:{position:'absolute',top:'20%',right:'10%',background:'rgba(0, 0, 0, 0.8)',padding:'16px',borderRadius:'8px',border:\"2px solid \".concat(MIREA_COLORS.success)},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",style:{color:MIREA_COLORS.text},children:\"\\u0424\\u043E\\u0440\\u043C\\u043E\\u0432\\u043E\\u0447\\u043D\\u0430\\u044F \\u043B\\u0438\\u043D\\u0438\\u044F\"}),/*#__PURE__*/_jsxs(Typography,{variant:\"h6\",style:{color:MIREA_COLORS.success,fontWeight:700},children:[((_sensorData$forming=sensorData.forming)===null||_sensorData$forming===void 0?void 0:(_sensorData$forming$b=_sensorData$forming.beltSpeed)===null||_sensorData$forming$b===void 0?void 0:_sensorData$forming$b.toFixed(0))||0,\" \\u043C/\\u043C\\u0438\\u043D\"]})]}),Object.entries(defects).map((_ref7,index)=>{let[type,count]=_ref7;return count>5&&/*#__PURE__*/_jsxs(Paper,{elevation:4,style:{position:'absolute',bottom:\"\".concat(20+index*15,\"%\"),left:'50%',transform:'translateX(-50%)',background:'rgba(255, 0, 0, 0.9)',padding:'16px',borderRadius:'8px',border:\"2px solid \".concat(MIREA_COLORS.error),display:'flex',alignItems:'center',gap:'8px'},children:[/*#__PURE__*/_jsx(Warning,{style:{color:MIREA_COLORS.text}}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",style:{color:MIREA_COLORS.text},children:[\"\\u041E\\u0431\\u043D\\u0430\\u0440\\u0443\\u0436\\u0435\\u043D\\u043E \",type==='bubbles'?'пузырей':type==='cracks'?'трещин':'сколов',\": \",count]})]},type);})]});};// Панель управления\nconst ControlPanel=_ref8=>{let{isPlaying,onPlayPause,onReset,cameraMode,onCameraModeChange,zoomLevel,onZoomChange,showDefects,onShowDefectsChange,showLabels,onShowLabelsChange}=_ref8;return/*#__PURE__*/_jsxs(Paper,{elevation:8,style:{position:'absolute',bottom:'20px',left:'50%',transform:'translateX(-50%)',display:'flex',gap:'16px',alignItems:'center',background:\"linear-gradient(135deg, \".concat(MIREA_COLORS.background,\"E6, \").concat(MIREA_COLORS.surfaceLight,\"E6)\"),backdropFilter:'blur(10px)',padding:'16px',borderRadius:'32px',zIndex:1001,border:\"1px solid \".concat(MIREA_COLORS.primary,\"60\")},children:[/*#__PURE__*/_jsx(Fab,{size:\"small\",style:{backgroundColor:isPlaying?MIREA_COLORS.secondary:MIREA_COLORS.primary},onClick:onPlayPause,children:isPlaying?/*#__PURE__*/_jsx(Pause,{}):/*#__PURE__*/_jsx(PlayArrow,{})}),/*#__PURE__*/_jsx(Fab,{size:\"small\",style:{backgroundColor:MIREA_COLORS.surfaceLight},onClick:onReset,children:/*#__PURE__*/_jsx(RotateLeft,{})}),/*#__PURE__*/_jsx(IconButton,{onClick:()=>onZoomChange(Math.max(1,zoomLevel-0.5)),children:/*#__PURE__*/_jsx(ZoomOut,{style:{color:MIREA_COLORS.text}})}),/*#__PURE__*/_jsx(\"div\",{style:{width:'100px'},children:/*#__PURE__*/_jsx(Slider,{value:zoomLevel,onChange:(_,value)=>onZoomChange(value),min:1,max:3,step:0.1,style:{color:MIREA_COLORS.primary}})}),/*#__PURE__*/_jsx(IconButton,{onClick:()=>onZoomChange(Math.min(3,zoomLevel+0.5)),children:/*#__PURE__*/_jsx(ZoomIn,{style:{color:MIREA_COLORS.text}})}),/*#__PURE__*/_jsx(\"div\",{style:{minWidth:'120px',marginRight:'16px'},children:/*#__PURE__*/_jsxs(FormControl,{size:\"small\",style:{width:'100%'},children:[/*#__PURE__*/_jsx(InputLabel,{style:{color:MIREA_COLORS.text},children:\"\\u041A\\u0430\\u043C\\u0435\\u0440\\u0430\"}),/*#__PURE__*/_jsxs(Select,{value:cameraMode,label:\"\\u041A\\u0430\\u043C\\u0435\\u0440\\u0430\",onChange:e=>onCameraModeChange(e.target.value),style:{color:MIREA_COLORS.text},sx:{'& .MuiOutlinedInput-notchedOutline':{borderColor:MIREA_COLORS.primary}},children:[/*#__PURE__*/_jsx(MenuItem,{value:\"orbit\",children:\"\\u041E\\u0440\\u0431\\u0438\\u0442\\u0430\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"fixed\",children:\"\\u0424\\u0438\\u043A\\u0441\\u0438\\u0440\\u043E\\u0432\\u0430\\u043D\\u043D\\u0430\\u044F\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"follow\",children:\"\\u0421\\u043B\\u0435\\u0434\\u044F\\u0449\\u0430\\u044F\"})]})]})}),/*#__PURE__*/_jsxs(FormGroup,{row:true,children:[/*#__PURE__*/_jsx(FormControlLabel,{control:/*#__PURE__*/_jsx(Checkbox,{checked:showDefects,onChange:e=>onShowDefectsChange(e.target.checked),style:{color:MIREA_COLORS.text},sx:{'&.Mui-checked':{color:MIREA_COLORS.primary}}}),label:/*#__PURE__*/_jsx(Typography,{style:{color:MIREA_COLORS.text},children:\"\\u0414\\u0435\\u0444\\u0435\\u043A\\u0442\\u044B\"})}),/*#__PURE__*/_jsx(FormControlLabel,{control:/*#__PURE__*/_jsx(Checkbox,{checked:showLabels,onChange:e=>onShowLabelsChange(e.target.checked),style:{color:MIREA_COLORS.text},sx:{'&.Mui-checked':{color:MIREA_COLORS.primary}}}),label:/*#__PURE__*/_jsx(Typography,{style:{color:MIREA_COLORS.text},children:\"\\u041C\\u0435\\u0442\\u043A\\u0438\"})})]})]});};// Главный компонент AR визуализации\nconst ARVisualization=()=>{const[sensorData,setSensorData]=useState({furnace:{temperature:1520,pressure:2.5,meltLevel:2.4},forming:{beltSpeed:155,moldTemp:325,coolingRate:1.2},defects:{bubbles:12,cracks:8,chips:5}});const[isPlaying,setIsPlaying]=useState(true);const[cameraMode,setCameraMode]=useState('orbit');const[zoomLevel,setZoomLevel]=useState(1);const[showDefects,setShowDefects]=useState(true);const[showLabels,setShowLabels]=useState(true);const[showOverlay,setShowOverlay]=useState(true);// Initialize WebSocket connection\nconst wsUrl=\"\".concat(process.env.REACT_APP_WS_URL||'ws://localhost:8000/ws');const{isConnected,sendMessage}=useWebSocket(wsUrl,{onMessage:data=>{// Handle real-time updates from WebSocket\nif(data.type==='sensor_update'&&data.data){// Update sensor data with real values from backend\nsetSensorData(prev=>{var _data$data$sensors,_data$data$sensors2,_data$data$sensors3,_data$data$sensors4,_data$data$sensors5,_data$data$sensors6;return _objectSpread(_objectSpread({},prev),{},{furnace:_objectSpread(_objectSpread({},prev.furnace),{},{temperature:((_data$data$sensors=data.data.sensors)===null||_data$data$sensors===void 0?void 0:_data$data$sensors.furnace_temperature)||prev.furnace.temperature,pressure:((_data$data$sensors2=data.data.sensors)===null||_data$data$sensors2===void 0?void 0:_data$data$sensors2.furnace_pressure)||prev.furnace.pressure,meltLevel:((_data$data$sensors3=data.data.sensors)===null||_data$data$sensors3===void 0?void 0:_data$data$sensors3.melt_level)||prev.furnace.meltLevel}),forming:_objectSpread(_objectSpread({},prev.forming),{},{beltSpeed:((_data$data$sensors4=data.data.sensors)===null||_data$data$sensors4===void 0?void 0:_data$data$sensors4.belt_speed)||prev.forming.beltSpeed,moldTemp:((_data$data$sensors5=data.data.sensors)===null||_data$data$sensors5===void 0?void 0:_data$data$sensors5.mold_temperature)||prev.forming.moldTemp,coolingRate:((_data$data$sensors6=data.data.sensors)===null||_data$data$sensors6===void 0?void 0:_data$data$sensors6.cooling_rate)||prev.forming.coolingRate})});});}else if(data.type==='realtime_update'&&data.data){// Handle general real-time updates\nconsole.log('Real-time update received:',data.data);}},onOpen:()=>{console.log('WebSocket connected to backend');// Subscribe to updates when connection is established\nsendMessage({type:'subscribe',topics:['sensors','realtime']});},onClose:()=>{console.log('WebSocket disconnected from backend');},onError:error=>{console.error('WebSocket error:',error);}});// Fetch initial data from backend API\nuseEffect(()=>{const fetchInitialData=async()=>{try{// Try to get digital twin state for initial values\nconst digitalTwinData=await systemApi.getDigitalTwinState();if(digitalTwinData.state){setSensorData(prev=>_objectSpread(_objectSpread({},prev),{},{furnace:_objectSpread(_objectSpread({},prev.furnace),{},{temperature:digitalTwinData.state.furnace_temperature||prev.furnace.temperature,meltLevel:digitalTwinData.state.melt_level/1000||prev.furnace.meltLevel// Convert units\n}),forming:_objectSpread(_objectSpread({},prev.forming),{},{beltSpeed:digitalTwinData.state.forming_belt_speed||prev.forming.beltSpeed})}));}}catch(error){console.error('Error fetching initial data:',error);// Continue with default values\n}};fetchInitialData();},[]);return/*#__PURE__*/_jsxs(\"div\",{style:{width:'100%',height:'100%',position:'relative'},children:[/*#__PURE__*/_jsx(Canvas,{camera:{position:[0,5,15],fov:50},style:{background:\"linear-gradient(to bottom, \".concat(MIREA_COLORS.background,\", \").concat(MIREA_COLORS.surfaceLight,\")\")},children:/*#__PURE__*/_jsx(GlassProductionScene,{sensorData:sensorData,showDefects:showDefects,showLabels:showLabels})}),/*#__PURE__*/_jsx(AROverlay,{sensorData:sensorData,defects:sensorData.defects,showOverlay:showOverlay}),/*#__PURE__*/_jsx(ControlPanel,{isPlaying:isPlaying,onPlayPause:()=>setIsPlaying(!isPlaying),onReset:()=>{setSensorData({furnace:{temperature:1520,pressure:2.5,meltLevel:2.4},forming:{beltSpeed:155,moldTemp:325,coolingRate:1.2},defects:{bubbles:12,cracks:8,chips:5}});},cameraMode:cameraMode,onCameraModeChange:setCameraMode,zoomLevel:zoomLevel,onZoomChange:setZoomLevel,showDefects:showDefects,onShowDefectsChange:setShowDefects,showLabels:showLabels,onShowLabelsChange:setShowLabels}),/*#__PURE__*/_jsx(Fab,{size:\"small\",style:{position:'absolute',top:'20px',right:'20px',zIndex:1001,backgroundColor:showOverlay?MIREA_COLORS.primary:MIREA_COLORS.surfaceLight},onClick:()=>setShowOverlay(!showOverlay),children:showOverlay?/*#__PURE__*/_jsx(VisibilityOff,{}):/*#__PURE__*/_jsx(Visibility,{})}),/*#__PURE__*/_jsx(Fab,{size:\"small\",style:{position:'absolute',top:'20px',right:'80px',zIndex:1001,backgroundColor:MIREA_COLORS.surfaceLight},children:/*#__PURE__*/_jsx(Settings,{})})]});};export default ARVisualization;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}